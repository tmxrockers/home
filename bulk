import { ChangeDetectionStrategy, Component, signal, computed, effect } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ConfirmationDialogComponent } from '../confirmation-dialog/confirmation-dialog.component';

// --- Data Structures & Types ---

type EtlFileStatus = 'pending' | 'error' | 'processed' | 'approved';

type EtlFileType = 
  | 'ITGL Open Positions' 
  | 'SP Headcount Monthly' 
  | 'SP Headcount Weekly'
  | 'ITCL Headcount Monthly'
  | 'ITCL Headcount Weekly'
  | 'SP Incremental Data';

interface EtlFile {
  id: string;
  name: EtlFileType;
  uploadDate: string;
  records: number;
  version: number;
  refreshDate: string;
  errors: number;
  status: EtlFileStatus;
  statusText: string;
}

// Fix: Define an interface for error column values to ensure proper type inference. This resolves multiple 'property does not exist on type unknown' errors.
interface ErrorColumn {
  value: string;
  isCorrected: boolean;
  errorType: string;
}

interface ErrorRecord {
  id: string;
  referenceColumns: { 
    'Person ID': string;
    'Resource': string;
    'Resource ID': string;
   };
  errorColumns: { [key: string]: ErrorColumn };
}

interface SummaryStat {
  label: string;
  value: string | number;
  icon: string;
  colorClass: string;
}

type DataType = 'Alpha' | 'Alpha Numeric' | 'Date' | 'Decimal' | 'TimeStamp';

interface ValidationRule {
  dataType: DataType;
  maxLength: number;
  isMandatory: boolean;
  pattern?: string;
  dbColumn: string;
}

const EDITABLE_FILE_TYPES: EtlFileType[] = [
  'SP Headcount Monthly',
  'SP Headcount Weekly',
  'ITCL Headcount Monthly',
  'ITCL Headcount Weekly',
];

// In-memory validation rules based on the provided spreadsheet
const SP_HEADCOUNT_VALIDATION_RULES: Record<string, ValidationRule> = {
  'Supplier': { dbColumn: 'SUPPLIER', isMandatory: true, maxLength: 85, dataType: 'Alpha Numeric', pattern: '^[a-zA-Z0-9 .,\\-@#&$/\'"{}\\[\\]<>~]+$' },
  'GDC ID': { dbColumn: 'GDC_ID', isMandatory: true, maxLength: 9, dataType: 'Alpha Numeric', pattern: '^[a-zA-Z0-9]+$' },
  'SOW Name': { dbColumn: 'SOW_NAME', isMandatory: true, maxLength: 250, dataType: 'Alpha Numeric', pattern: '^[a-zA-Z0-9 .,\\-@#&$/\'"{}\\[\\]<>~]+$' },
  'Ariba Contract ID': { dbColumn: 'ARIBA_CONTRACT_ID', isMandatory: false, maxLength: 250, dataType: 'Alpha Numeric', pattern: '^[a-zA-Z0-9 .,\\-@#&$/\'"{}\\[\\]<>~]+$' },
  'Resource Status': { dbColumn: 'RESOURCE_STATUS', isMandatory: true, maxLength: 30, dataType: 'Alpha', pattern: '^[a-zA-Z ]+$' },
  'Original Start Date': { dbColumn: 'ORIGINAL_START_DATE', isMandatory: false, maxLength: 10, dataType: 'Date', pattern: 'DATE_FORMAT' },
  'Bill Rate [USD]': { dbColumn: 'CURRENT_BILL_RATE', isMandatory: false, maxLength: 126, dataType: 'Decimal', pattern: '^\\d+(\\.\\d{1,2})?$' },
  'Currency': { dbColumn: 'CURRENCY', isMandatory: true, maxLength: 50, dataType: 'Alpha', pattern: '^[a-zA-Z]+$' },
  'Country': { dbColumn: 'COUNTRY', isMandatory: true, maxLength: 50, dataType: 'Alpha Numeric', pattern: '^[a-zA-Z0-9 .,\\-@#&$/\'"{}\\[\\]<>~]+$' },
  'Cost Center': { dbColumn: 'COST_CENTER', isMandatory: true, maxLength: 50, dataType: 'Alpha Numeric', pattern: '^[a-zA-Z0-9]+$' },
};


@Component({
  selector: 'app-etl-governance',
  imports: [CommonModule, ConfirmationDialogComponent],
  templateUrl: './etl-governance.component.html',
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class EtlGovernanceComponent {
  // --- State Signals ---
  viewMode = signal<'list' | 'detail' | 'bulkEdit'>('list');
  activeTab = signal<'pending' | 'reviewed' | 'approved'>('pending');
  allFiles = signal<EtlFile[]>([]);
  selectedFile = signal<EtlFile | null>(null);

  // Detail View State
  allErrorRecords = signal<ErrorRecord[]>([]);
  filterSearchTerm = signal('');
  showAutoCorrected = signal(false);
  editingError = signal<{ recordId: string; field: string; originalValue: string } | null>(null);

  // Bulk Edit State
  selectedErrorField = signal<string>('');
  correctionValue = signal('');
  correctionValueError = signal<string | null>(null);
  selectedRecordIds = signal<Set<string>>(new Set());
  currentPage = signal(1);
  pageSize = signal(10);

  // --- Computed Signals ---

  filteredFiles = computed(() => {
    const tab = this.activeTab();
    let statuses: EtlFileStatus[];
    if (tab === 'pending') {
      statuses = ['pending', 'error'];
    } else if (tab === 'reviewed') {
      statuses = ['processed'];
    } else {
      statuses = ['approved'];
    }
    return this.allFiles().filter(file => statuses.includes(file.status));
  });

  pendingReviewCount = computed(() => this.allFiles().filter(f => f.status === 'pending' || f.status === 'error').length);
  reviewedCount = computed(() => this.allFiles().filter(f => f.status === 'processed').length);
  approveSnapshotsCount = computed(() => this.allFiles().filter(f => f.status === 'approved').length);

  isCurrentFileEditable = computed(() => {
    const file = this.selectedFile();
    return file ? EDITABLE_FILE_TYPES.includes(file.name) : false;
  });

  correctedErrorCount = computed(() => {
    return this.allErrorRecords().reduce((count, record) => {
      // Corrected: Use Object.values and ensure the value is properly typed as ErrorColumn.
      const correctedInRecord = Object.values(record.errorColumns).filter((col: ErrorColumn) => col.isCorrected).length;
      return count + correctedInRecord;
    }, 0);
  });
  
  summaryStats = computed<SummaryStat[]>(() => {
    const file = this.selectedFile();
    if (!file) return [];
    return [
      { label: 'File Name', value: file.name, icon: 'description', colorClass: 'bg-secondary' },
      { label: 'Total Records', value: file.records.toLocaleString(), icon: 'storage', colorClass: 'bg-info' },
      { label: 'Version', value: file.version, icon: 'layers', colorClass: 'bg-primary' },
      { label: 'Total Errors', value: file.errors, icon: 'error', colorClass: 'bg-danger' },
      // Corrected: Prepend 'this.' to access the class member signal.
      { label: 'Corrected Errors', value: this.correctedErrorCount(), icon: 'task_alt', colorClass: 'bg-success' },
      { label: 'Status', value: file.statusText, icon: 'flag', colorClass: 'bg-warning' }
    ];
  });
  
  filteredErrorRecords = computed(() => {
    const term = this.filterSearchTerm().toLowerCase();
    const showCorrected = this.showAutoCorrected();
    return this.allErrorRecords().filter(record => {
      if (!showCorrected && Object.values(record.errorColumns).every((col: ErrorColumn) => col.isCorrected)) {
        return false;
      }
      if (term) {
        const refs = Object.values(record.referenceColumns).join(' ').toLowerCase();
        // FIX: Explicitly type 'val' as ErrorColumn to fix 'property does not exist on type unknown' error.
        const errs = Object.entries(record.errorColumns).map(([key, val]: [string, ErrorColumn]) => `${key} ${val.value}`).join(' ').toLowerCase();
        return refs.includes(term) || errs.includes(term);
      }
      return true;
    });
  });

  // --- Bulk Edit Computed Signals ---
  errorFieldsForSelection = computed(() => {
    const fields = new Set<string>();
    this.allErrorRecords().forEach(record => {
      // FIX: Explicitly type 'col' as ErrorColumn to fix 'property does not exist on type unknown' error.
      Object.entries(record.errorColumns).forEach(([fieldName, col]: [string, ErrorColumn]) => {
        if (!col.isCorrected) {
          fields.add(fieldName);
        }
      });
    });
    return Array.from(fields).sort();
  });

  recordsForSelectedField = computed(() => {
    const field = this.selectedErrorField();
    if (!field) return [];
    return this.allErrorRecords().filter(record => 
        record.errorColumns[field] && !record.errorColumns[field].isCorrected
    );
  });

  totalRecordsForPagination = computed(() => this.recordsForSelectedField().length);

  totalPages = computed(() => Math.ceil(this.totalRecordsForPagination() / this.pageSize()));

  paginationPages = computed(() => Array.from({ length: this.totalPages() }, (_, i) => i + 1));

  paginatedRecords = computed(() => {
    const records = this.recordsForSelectedField();
    const startIndex = (this.currentPage() - 1) * this.pageSize();
    return records.slice(startIndex, startIndex + this.pageSize());
  });

  isAllVisibleSelected = computed(() => {
    const visibleIds = this.paginatedRecords().map(r => r.id);
    if(visibleIds.length === 0) return false;
    return visibleIds.every(id => this.selectedRecordIds().has(id));
  });

  selectedFieldValidationRules = computed<ValidationRule | null>(() => {
    const field = this.selectedErrorField();
    if (!field) return null;
    return SP_HEADCOUNT_VALIDATION_RULES[field] || null;
  });

  constructor() {
    this.allFiles.set(this.generateMockFiles());
    // When a file is selected, generate its error records.
    effect(() => {
      const file = this.selectedFile();
      if (file && (this.viewMode() === 'detail' || this.viewMode() === 'bulkEdit')) {
        this.allErrorRecords.set(this.generateMockErrorRecords(file));
      } else {
        this.allErrorRecords.set([]);
      }
    });
  }

  private generateMockFiles(): EtlFile[] {
    return [
      { id: 'f1', name: 'SP Headcount Monthly', uploadDate: '2024-07-22 10:30 AM', records: 15432, version: 3, refreshDate: '2024-07-22', errors: 500, status: 'error', statusText: 'Review Required' },
      { id: 'f2', name: 'ITGL Open Positions', uploadDate: '2024-07-21 09:00 AM', records: 800, version: 1, refreshDate: '2024-07-21', errors: 15, status: 'pending', statusText: 'Pending' },
      { id: 'f3', name: 'SP Headcount Weekly', uploadDate: '2024-07-20 05:00 PM', records: 1200, version: 2, refreshDate: '2024-07-20', errors: 0, status: 'processed', statusText: 'Processed' },
      { id: 'f4', name: 'ITCL Headcount Monthly', uploadDate: '2024-07-19 11:00 AM', records: 4500, version: 1, refreshDate: '2024-07-19', errors: 0, status: 'approved', statusText: 'Approved' },
    ];
  }

  private generateMockErrorRecords(file: EtlFile): ErrorRecord[] {
    const records: ErrorRecord[] = [];
    if (!this.isCurrentFileEditable()) return [];

    const errorFields = Object.keys(SP_HEADCOUNT_VALIDATION_RULES);
    const firstNames = ['John', 'Jane', 'Peter', 'Mary', 'David', 'Susan'];
    const lastNames = ['Doe', 'Smith', 'Jones', 'Williams', 'Brown', 'Davis'];

    for (let i = 1; i <= 500; i++) {
        const errorField = errorFields[i % errorFields.length];
        const rule = SP_HEADCOUNT_VALIDATION_RULES[errorField];
        let errorValue = '';
        let errorType = '';

        const errorCategory = i % 3;
        switch (errorCategory) {
            case 0: // Mandatory field error
                errorValue = '';
                errorType = 'Mandatory';
                break;
            case 1: // Max length error
                errorValue = 'X'.repeat(rule.maxLength + 5);
                errorType = 'Max Length';
                break;
            case 2: // Pattern error
                errorValue = rule.dataType === 'Date' ? '2024/12/31' : 'Invalid@!';
                errorType = 'Pattern';
                break;
        }

        records.push({
            id: `err-${file.id}-${i}`,
            referenceColumns: {
                'Person ID': (100000 + i).toString(),
                'Resource': `${firstNames[i % firstNames.length]} ${lastNames[i % lastNames.length]}`,
                'Resource ID': `R${200000 + i}`,
            },
            errorColumns: {
                [errorField]: { value: errorValue, isCorrected: false, errorType }
            }
        });
    }
    return records;
  }

  // --- Methods ---
  changeTab(tab: 'pending' | 'reviewed' | 'approved'): void {
    this.activeTab.set(tab);
  }

  reviewFile(file: EtlFile): void {
    this.selectedFile.set(file);
    this.viewMode.set('detail');
  }

  goBackToList(): void {
    this.viewMode.set('list');
    this.selectedFile.set(null);
  }
  
  goBackToDetailView(): void {
    this.viewMode.set('detail');
    // Reset bulk edit state
    this.selectedErrorField.set('');
    this.selectedRecordIds.set(new Set());
    this.correctionValue.set('');
    this.currentPage.set(1);
  }

  navigateToBulkEdit(): void {
    this.viewMode.set('bulkEdit');
    // Reset bulk edit state on navigation
    this.selectedErrorField.set('');
    this.selectedRecordIds.set(new Set());
    this.correctionValue.set('');
    this.currentPage.set(1);
  }

  clearFilters(): void {
    this.filterSearchTerm.set('');
  }

  startEditing(recordId: string, field: string, value: string): void {
    this.editingError.set({ recordId, field, originalValue: value });
  }

  cancelEditing(): void {
    this.editingError.set(null);
  }

  saveEditing(recordId: string, field: string, event: Event): void {
    const newValue = (event.target as HTMLInputElement).value;
    this.allErrorRecords.update(records => {
      const recordIndex = records.findIndex(r => r.id === recordId);
      if (recordIndex > -1) {
        const newRecords = [...records];
        const newRecord = { ...newRecords[recordIndex] };
        newRecord.errorColumns = { ...newRecord.errorColumns };
        if (newRecord.errorColumns[field]) {
           newRecord.errorColumns[field] = { ...newRecord.errorColumns[field], value: newValue, isCorrected: true };
           newRecords[recordIndex] = newRecord;
        }
        return newRecords;
      }
      return records;
    });
    this.cancelEditing();
  }

  // Bulk Edit Methods
  onFieldSelectionChange(fieldName: string): void {
    this.selectedErrorField.set(fieldName);
    // Reset dependent state
    this.selectedRecordIds.set(new Set());
    this.currentPage.set(1);
    this.correctionValue.set('');
    this.correctionValueError.set(null);
  }
  
  toggleRecordSelection(recordId: string): void {
    this.selectedRecordIds.update(currentSet => {
      const newSet = new Set(currentSet);
      if (newSet.has(recordId)) {
        newSet.delete(recordId);
      } else {
        newSet.add(recordId);
      }
      return newSet;
    });
  }

  toggleSelectAllVisible(): void {
    const visibleIds = this.paginatedRecords().map(r => r.id);
    const allSelected = this.isAllVisibleSelected();
    this.selectedRecordIds.update(currentSet => {
      const newSet = new Set(currentSet);
      if (allSelected) {
        visibleIds.forEach(id => newSet.delete(id));
      } else {
        visibleIds.forEach(id => newSet.add(id));
      }
      return newSet;
    });
  }
  
  goToPage(page: number): void {
    if (page >= 1 && page <= this.totalPages()) {
      this.currentPage.set(page);
    }
  }

  onCorrectionValueChange(value: string): void {
    this.correctionValue.set(value);
    this.correctionValueError.set(this.validateCorrectionValue(value));
  }

  private validateCorrectionValue(value: string): string | null {
    const rules = this.selectedFieldValidationRules();
    if (!rules) return null;

    if (rules.isMandatory && !value.trim()) {
      return 'This field is mandatory.';
    }
    if (value.length > rules.maxLength) {
      return `Value cannot exceed ${rules.maxLength} characters.`;
    }
    if (rules.pattern && rules.pattern !== 'DATE_FORMAT' && value) {
      const regex = new RegExp(rules.pattern);
      if (!regex.test(value)) {
        return 'Value does not match the required pattern.';
      }
    }
    // Simple date format check for demo purposes
    if (rules.dataType === 'Date' && value && !/^\d{4}-\d{2}-\d{2}$/.test(value)) {
      return 'Please use YYYY-MM-DD format for dates.';
    }

    return null;
  }
  
  applyBulkChanges(): void {
    const field = this.selectedErrorField();
    const newValue = this.correctionValue();
    const idsToUpdate = this.selectedRecordIds();
    
    if (!field || !newValue.trim() || idsToUpdate.size === 0 || this.correctionValueError()) return;
    
    this.allErrorRecords.update(records => {
        return records.map(record => {
            if (idsToUpdate.has(record.id)) {
                const newRecord = { ...record };
                newRecord.errorColumns = { ...record.errorColumns };
                newRecord.errorColumns[field] = {
                    ...newRecord.errorColumns[field],
                    value: newValue,
                    isCorrected: true,
                };
                return newRecord;
            }
            return record;
        });
    });

    // Reset UI after applying changes
    this.selectedRecordIds.set(new Set());
    this.correctionValue.set('');
  }
}






<div class="container-fluid p-0">
@switch (viewMode()) {
  @case ('list') {
    <!-- List View -->
    <div class="card shadow-sm animate-tab-content-fade-in">
      <div class="card-header bg-white d-flex flex-column flex-md-row justify-content-between align-items-center p-3">
        <div>
          <h1 class="h4 mb-0">GDR Dashboard <span class="fw-normal text-muted small align-middle">&gt;</span> ETL Governance</h1>
        </div>
        <button class="btn btn-primary btn-sm d-flex align-items-center gap-2 mt-3 mt-md-0">
          <span class="material-symbols-sharp">calendar_month</span>
          Generate Monthly & Weekly Headcount
        </button>
      </div>
      <div class="card-body p-3">
        <!-- Tabs -->
        <div class="d-flex border-bottom mb-3">
          <button class="btn btn-link text-decoration-none" [class.fw-bold]="activeTab() === 'pending' || activeTab() === 'error'" [class.text-primary]="activeTab() === 'pending' || activeTab() === 'error'" [class.text-muted]="activeTab() !== 'pending' && activeTab() !== 'error'" (click)="changeTab('pending')">
            Pending Review <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis">{{ pendingReviewCount() }}</span>
          </button>
          <button class="btn btn-link text-decoration-none" [class.fw-bold]="activeTab() === 'processed'" [class.text-primary]="activeTab() === 'processed'" [class.text-muted]="activeTab() !== 'processed'" (click)="changeTab('reviewed')">
            Reviewed <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis">{{ reviewedCount() }}</span>
          </button>
          <button class="btn btn-link text-decoration-none" [class.fw-bold]="activeTab() === 'approved'" [class.text-primary]="activeTab() === 'approved'" [class.text-muted]="activeTab() !== 'approved'" (click)="changeTab('approved')">
            Approve Snapshots <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis">{{ approveSnapshotsCount() }}</span>
          </button>
        </div>

        <!-- Filters -->
        <div class="d-flex flex-wrap gap-2 align-items-center mb-3 small">
          <select class="form-select form-select-sm" style="width: 15rem;">
            <option selected>Select Upload Type</option>
            <option value="1">ITGL Open Positions</option>
            <option value="2">SP Headcount Monthly</option>
            <option value="3">SP Incremental Data</option>
          </select>
          <input type="date" class="form-control form-control-sm" style="width: 10rem;">
          <input type="date" class="form-control form-control-sm" style="width: 10rem;">
          <button class="btn btn-sm btn-link text-secondary">Clear</button>
          <div class="form-check ms-auto">
            <input class="form-check-input" type="checkbox" id="showFinalSnapshots">
            <label class="form-check-label" for="showFinalSnapshots">Show final snapshots</label>
          </div>
        </div>

        <!-- Table -->
        <div class="list-group">
          @for (file of filteredFiles(); track file.id) {
            <div class="list-group-item list-group-item-action mb-2 border rounded-2">
              <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center">
                <!-- File Info -->
                <div class="flex-grow-1 mb-3 mb-md-0">
                  <div class="d-flex align-items-center gap-2">
                    <h5 class="mb-0 fw-semibold">{{ file.name }}</h5>
                    @if(file.status === 'error') {
                      <span class="badge" style="background-color: #dc3545; color: #ffc107;">{{ file.statusText }}</span>
                    } @else if (file.status === 'processed') {
                      <span class="badge bg-success">{{ file.statusText }}</span>
                    }
                  </div>
                  <p class="small text-muted mb-0">Uploaded On: {{ file.uploadDate }}</p>
                </div>

                <!-- Stats -->
                <div class="d-flex flex-wrap gap-4 text-center mx-md-auto">
                  <div><p class="fw-bold mb-0">{{ file.records.toLocaleString() }}</p><p class="small text-muted mb-0">Number of records</p></div>
                  <div><p class="fw-bold mb-0">{{ file.version }}</p><p class="small text-muted mb-0">Version</p></div>
                  <div><p class="fw-bold mb-0">{{ file.refreshDate }}</p><p class="small text-muted mb-0">Latest Fieldglass refresh date</p></div>
                  <div><p class="fw-bold mb-0">{{ file.errors }}</p><p class="small text-muted mb-0">Errors</p></div>
                </div>

                <!-- Actions -->
                <div class="d-flex gap-2 ms-md-auto mt-3 mt-md-0">
                  <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1"><span class="material-symbols-sharp small">download</span> Download</button>
                  @if (file.status === 'pending' || file.status === 'error') {
                    <button (click)="reviewFile(file)" class="btn btn-sm btn-success d-flex align-items-center gap-1"><span class="material-symbols-sharp small">rate_review</span> Review</button>
                  } @else {
                    <button (click)="reviewFile(file)" class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1"><span class="material-symbols-sharp small">visibility</span> View Details</button>
                  }
                </div>
              </div>
            </div>
          } @empty {
            <div class="text-center p-5 text-muted">
              <p>No files found for this category.</p>
            </div>
          }
        </div>
      </div>
    </div>
  }
  @case ('detail') {
    @if (selectedFile(); as file) {
      <!-- Detail/Review View -->
      <div class="animate-tab-content-fade-in">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <p class="h6 text-muted mb-0">
            GDR Dashboard <span class="fw-normal">&gt;</span> ETL Governance <span class="fw-normal">&gt;</span> Governance Summary <span class="fw-normal">&gt;</span> {{ file.name }}
          </p>
          <button (click)="goBackToList()" class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1">
            <span class="material-symbols-sharp">arrow_back</span> Back
          </button>
        </div>

        <!-- Summary Cards -->
        <div class="row g-3 mb-4 row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-6">
          @for (stat of summaryStats(); track stat.label) {
            <div class="col">
              <div class="card h-100 shadow-sm border-0">
                <div class="card-body d-flex align-items-center gap-3 p-3">
                  <div class="d-flex align-items-center justify-content-center rounded text-white" [class]="stat.colorClass" style="width: 48px; height: 48px;">
                    <span class="material-symbols-sharp">{{ stat.icon }}</span>
                  </div>
                  <div>
                    <h2 class="h4 fw-bold mb-0">{{ stat.value }}</h2>
                    <p class="small text-muted mb-0 text-truncate" [title]="stat.label">{{ stat.label }}</p>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
        
        @if (isCurrentFileEditable()) {
          <!-- Action Buttons -->
          <div class="d-flex gap-2 justify-content-end mb-3">
            <button class="btn btn-sm btn-link text-primary text-decoration-none d-flex align-items-center gap-1"><span class="material-symbols-sharp">edit</span> Correct Reference Data</button>
            <button (click)="navigateToBulkEdit()" class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1">
              <span class="material-symbols-sharp">edit_note</span> Bulk Edit
            </button>
            <button class="btn btn-sm btn-primary d-flex align-items-center gap-1"><span class="material-symbols-sharp">download</span> Download</button>
          </div>
        }

        <!-- Error Records Table -->
        <div class="card shadow-sm">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h3 class="h6 mb-0">Error Records</h3>
            <a href="#" class="small text-decoration-none"><span class="material-symbols-sharp small align-middle">download</span> Download Error Report</a>
          </div>
          <div class="card-body">
              @if (isCurrentFileEditable()) {
                <!-- Error Filters -->
                <div class="d-flex align-items-center gap-2 mb-3">
                   <div class="input-group input-group-sm" style="width: 25rem;">
                     <span class="input-group-text"><span class="material-symbols-sharp small">search</span></span>
                     <input type="text" class="form-control" placeholder="Search by Resource, ID, or error..." [value]="filterSearchTerm()" (input)="filterSearchTerm.set($any($event.target).value)">
                  </div>
                  <button class="btn btn-sm btn-link text-secondary" (click)="clearFilters()">Clear</button>
                  <div class="form-check ms-3">
                    <input class="form-check-input" type="checkbox" id="showAutoCorrected" [checked]="showAutoCorrected()" (change)="showAutoCorrected.set($any($event.target).checked)">
                    <label class="form-check-label small" for="showAutoCorrected">Show Auto Corrected</label>
                  </div>
                </div>
              } @else {
                <div class="alert alert-info small">
                  This file type does not support error correction. Viewing in read-only mode.
                </div>
              }

              <!-- Error Table -->
              <div class="table-responsive border rounded-2 styled-scrollbar" style="max-height: 50vh;">
                  <table class="table table-sm small">
                      <thead class="sticky-top" style="background-color: #e9ecef; color: #495057;">
                          <tr>
                              <th class="ps-3">Reference Columns</th>
                              <th>Error Columns <span class="badge bg-danger-subtle text-danger-emphasis small">Errors: {{file.errors}}</span> <span class="badge bg-success-subtle text-success-emphasis small ms-1">Corrected Errors: {{ correctedErrorCount() }}</span></th>
                              @if(isCurrentFileEditable()) {
                                <th class="text-end pe-3">Actions</th>
                              }
                          </tr>
                      </thead>
                      <tbody>
                          @for (record of filteredErrorRecords(); track record.id) {
                              <tr class="align-middle">
                                  <td class="ps-3" style="min-width: 250px;">
                                      @for(item of record.referenceColumns | keyvalue; track item.key) {
                                          <div>
                                              <p class="mb-0 fw-semibold">{{ item.key }}:</p>
                                              <p class="mb-1 text-muted">{{ item.value }}</p>
                                          </div>
                                      }
                                  </td>
                                  <td>
                                    @for(item of record.errorColumns | keyvalue; track item.key) {
                                          <div>
                                              <p class="mb-0 fw-semibold">{{ item.key }}</p>
                                              @if (editingError()?.recordId === record.id && editingError()?.field === item.key) {
                                                <div class="d-flex align-items-center gap-1">
                                                  <input type="text" class="form-control form-control-sm" [value]="item.value.value" (keydown.enter)="saveEditing(record.id, item.key, $event)" (keydown.escape)="cancelEditing()">
                                                </div>
                                              } @else {
                                                <p class="mb-1 rounded px-1" 
                                                  [class.bg-light]="true" 
                                                  [class.text-success]="item.value.isCorrected" 
                                                  (dblclick)="isCurrentFileEditable() && startEditing(record.id, item.key, item.value.value)" 
                                                  [title]="isCurrentFileEditable() ? 'Double-click to edit' : ''">
                                                  {{ item.value.value }}
                                                  @if(item.value.isCorrected) { <span class="material-symbols-sharp small text-success align-middle">check_circle</span> }
                                                </p>
                                              }
                                          </div>
                                      }
                                  </td>
                                  @if(isCurrentFileEditable()) {
                                    <td class="text-end pe-3">
                                      <div class="d-flex justify-content-end gap-1">
                                        <button class="btn btn-sm btn-outline-secondary">View Full Records</button>
                                        <button class="btn btn-sm btn-outline-danger">Delete</button>
                                        <button class="btn btn-sm btn-success">Save</button>
                                      </div>
                                    </td>
                                  }
                              </tr>
                          } @empty {
                              <tr>
                                  <td [attr.colspan]="isCurrentFileEditable() ? 3 : 2" class="text-center p-5 text-muted">
                                      No records match your current filters.
                                  </td>
                              </tr>
                          }
                      </tbody>
                  </table>
              </div>
          </div>
        </div>
      </div>
    }
  }
  @case ('bulkEdit') {
     @if (selectedFile(); as file) {
      <!-- Bulk Edit View -->
      <div class="animate-tab-content-fade-in">
         <div class="d-flex justify-content-between align-items-center mb-3">
            <p class="h6 text-muted mb-0">
              GDR Dashboard <span class="fw-normal">&gt;</span> ... <span class="fw-normal">&gt;</span> {{ file.name }} <span class="fw-normal">&gt;</span> Bulk Edit
            </p>
            <button (click)="goBackToDetailView()" class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1">
              <span class="material-symbols-sharp">arrow_back</span> Back to Summary
            </button>
          </div>

          <div class="row g-4">
            <!-- Left Panel: Record Selection -->
            <div class="col-lg-8">
              <div class="card shadow-sm mb-4">
                  <div class="card-body">
                      <h3 class="h6 fw-bold">Step 1: Select Field to Correct</h3>
                      <p class="small text-muted mb-2">Choose the error field you want to fix for multiple records at once.</p>
                      <select class="form-select" [value]="selectedErrorField()" (change)="onFieldSelectionChange($any($event.target).value)">
                          <option value="" disabled>-- Select an error field --</option>
                          @for(field of errorFieldsForSelection(); track field) {
                              <option [value]="field">{{ field }}</option>
                          }
                      </select>
                  </div>
              </div>

              @if (selectedErrorField()) {
                <div class="card shadow-sm animate-slide-fade-in" style="animation-duration: 0.2s;">
                  <div class="card-header bg-white">
                    <h3 class="h6 fw-bold mb-0">Step 2: Review & Select Records</h3>
                    <p class="small text-muted mb-0">Showing records with errors for the '<strong>{{ selectedErrorField() }}</strong>' field. Total found: {{ totalRecordsForPagination() }}</p>
                  </div>
                  <div class="table-responsive styled-scrollbar">
                    <table class="table table-hover table-sm small mb-0" style="table-layout: fixed; width: 100%;">
                      <thead class="thead-primary">
                        <tr>
                          <th class="ps-3" style="width: 3rem;" title="Select all on page">
                            <input class="form-check-input" type="checkbox" title="Select/Deselect All Visible on this Page"
                                  [checked]="isAllVisibleSelected()" (change)="toggleSelectAllVisible()">
                          </th>
                          <th style="width: 15%;">PERSON ID</th>
                          <th style="width: 15%;">RESOURCE ID</th>
                          <th style="width: 25%;">RESOURCE</th>
                          <th style="width: 15%;">ERROR TYPE</th>
                          <th class="pe-3" style="width: 30%;">CURRENT VALUE</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for(record of paginatedRecords(); track record.id) {
                          <tr class="align-middle">
                            <td class="ps-3" [title]="'Select record for ' + record.referenceColumns['Resource']">
                              <input class="form-check-input" type="checkbox" [id]="'select-bulk-' + record.id"
                                    [checked]="selectedRecordIds().has(record.id)" (change)="toggleRecordSelection(record.id)">
                            </td>
                            <td class="text-truncate" [title]="record.referenceColumns['Person ID']">{{ record.referenceColumns['Person ID'] }}</td>
                            <td class="text-truncate" [title]="record.referenceColumns['Resource ID']">{{ record.referenceColumns['Resource ID'] }}</td>
                            <td class="text-truncate" [title]="record.referenceColumns['Resource']">{{ record.referenceColumns['Resource'] }}</td>
                            <td [title]="record.errorColumns[selectedErrorField()].errorType">
                              <span class="badge bg-danger-subtle text-danger-emphasis fw-normal">
                                {{ record.errorColumns[selectedErrorField()].errorType }}
                              </span>
                            </td>
                            <td class="pe-3 font-monospace" [title]="record.errorColumns[selectedErrorField()].value">
                                <div class="text-truncate">{{ record.errorColumns[selectedErrorField()].value }}</div>
                            </td>
                          </tr>
                        } @empty {
                           <tr><td colspan="6" class="text-center text-muted p-5">No uncorrected errors found for this field.</td></tr>
                        }
                      </tbody>
                    </table>
                  </div>
                  @if(totalPages() > 1) {
                    <div class="card-footer d-flex justify-content-between align-items-center">
                       <p class="small text-muted mb-0">Page {{ currentPage() }} of {{ totalPages() }}</p>
                        <nav>
                          <ul class="pagination pagination-sm mb-0">
                            <li class="page-item" [class.disabled]="currentPage() === 1"><a class="page-link" href="#" (click)="$event.preventDefault(); goToPage(currentPage() - 1)">&laquo;</a></li>
                            @for(page of paginationPages(); track page) {
                               @if(totalPages() <= 7 || page <= 3 || page > totalPages() - 3 || (page >= currentPage() - 1 && page <= currentPage() + 1)) {
                                <li class="page-item" [class.active]="currentPage() === page"><a class="page-link" href="#" (click)="$event.preventDefault(); goToPage(page)">{{ page }}</a></li>
                              } @else if (page === 4 || page === totalPages() - 3) {
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                              }
                            }
                            <li class="page-item" [class.disabled]="currentPage() === totalPages()"><a class="page-link" href="#" (click)="$event.preventDefault(); goToPage(currentPage() + 1)">&raquo;</a></li>
                          </ul>
                        </nav>
                    </div>
                  }
                </div>
              }
            </div>

            <!-- Right Panel: Edit Controls -->
            <div class="col-lg-4">
              <div class="card shadow-sm position-sticky" style="top: 1rem;">
                <div class="card-header bg-white">
                   <h3 class="h6 fw-bold mb-0">Step 3: Apply Correction</h3>
                </div>
                <div class="card-body vstack gap-3">
                  <div class="text-center bg-primary-subtle p-3 rounded-2">
                    <p class="h4 fw-bold text-primary mb-0">{{ selectedRecordIds().size }}</p>
                    <p class="small text-muted mb-0">Record(s) Selected</p>
                  </div>
                  
                  <div>
                    <label for="correctionValue" class="form-label small">New Value for '<strong>{{ selectedErrorField() || 'N/A' }}</strong>'</label>
                    <input [type]="selectedFieldValidationRules()?.dataType === 'Date' ? 'date' : 'text'"
                           id="correctionValue" class="form-control"
                           [class.is-invalid]="correctionValueError()"
                           [placeholder]="selectedFieldValidationRules()?.dataType === 'Date' ? '' : 'Enter new value'"
                           [value]="correctionValue()"
                           (input)="onCorrectionValueChange($any($event.target).value)"
                           [attr.maxlength]="selectedFieldValidationRules()?.dataType !== 'Date' ? selectedFieldValidationRules()?.maxLength : null"
                           [disabled]="!selectedErrorField()">
                    @if (correctionValueError(); as error) {
                      <div class="invalid-feedback d-block mt-1 small">{{ error }}</div>
                    }
                    @if (selectedFieldValidationRules()?.dataType === 'Date' && !correctionValueError()) {
                      <div class="form-text small">Please use YYYY-MM-DD format.</div>
                    }
                  </div>
                  <div class="d-grid">
                    <button (click)="applyBulkChanges()"
                            [disabled]="selectedRecordIds().size === 0 || !selectedErrorField() || !!correctionValueError()"
                            class="btn btn-primary">
                        Apply Update to {{ selectedRecordIds().size }} Record(s)
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
      </div>
    }
  }
}
</div>
